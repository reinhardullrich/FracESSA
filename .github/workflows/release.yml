name: Build

on:
  release:
    types: [ published ]

jobs:
  # ============================================================================
  # Linux Build (Ubuntu 22.04 - better runner availability)
  # ============================================================================
  build-linux:
    runs-on: ubuntu-22.04  # glibc 2.35 - works on most modern systems
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install GMP
      run: |
        sudo apt-get update
        sudo apt-get install -y libgmp-dev libgmpxx4ldbl
    
    - name: Configure CMake
      working-directory: cpp
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DENABLE_STATIC_LINKING=ON
    
    - name: Build
      working-directory: cpp
      run: cmake --build build --parallel $(nproc)
    
    - name: Test
      working-directory: cpp
      run: |
        cd build
        ./fracessa --help
    
    - name: Upload Linux Binary
      uses: actions/upload-artifact@v4
      with:
        name: fracessa-linux-x86_64
        path: cpp/build/fracessa
        retention-days: 30

  # ============================================================================
  # macOS Build
  # ============================================================================
  build-macos:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install pkg-config and GMP
      run: |
        brew install pkg-config gmp
    
    - name: Set up GMP environment variables
      run: |
        # Locate the installation prefix for gmp
        # The prefix is the root directory where the package was installed (e.g., /opt/homebrew)
        GMP_PREFIX=$(brew --prefix gmp)
        
        # Export the necessary environment variables for CMake to find GMP
        # These variables are standard hints for CMake's FindGMP module
        echo "GMP_ROOT=$GMP_PREFIX" >> $GITHUB_ENV
        echo "GMP_INCLUDE_DIR=$GMP_PREFIX/include" >> $GITHUB_ENV
        echo "GMP_LIBRARY_DIR=$GMP_PREFIX/lib" >> $GITHUB_ENV
        echo "GMP_PREFIX=$GMP_PREFIX" >> $GITHUB_ENV
        
        # Set PKG_CONFIG_PATH to help pkg-config find GMP's .pc files
        PKG_CONFIG_PATH="$GMP_PREFIX/lib/pkgconfig"
        if [ -d "$PKG_CONFIG_PATH" ]; then
          echo "PKG_CONFIG_PATH=$PKG_CONFIG_PATH" >> $GITHUB_ENV
          echo "Set PKG_CONFIG_PATH=$PKG_CONFIG_PATH"
        fi
        
        # Verify GMP installation
        echo "GMP installed at: $GMP_PREFIX"
        echo "GMP include dir: $GMP_PREFIX/include"
        echo "GMP library dir: $GMP_PREFIX/lib"
        ls -la $GMP_PREFIX/include/gmp*.h || echo "Warning: GMP headers not found in expected location"
        ls -la $GMP_PREFIX/lib/libgmp* || echo "Warning: GMP libraries not found in expected location"
        
        # Verify pkg-config can find GMP
        if command -v pkg-config &> /dev/null; then
          echo "Checking pkg-config for GMP:"
          pkg-config --modversion gmp || echo "Warning: pkg-config cannot find GMP"
        fi
    
    - name: Configure CMake
      working-directory: cpp
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DENABLE_STATIC_LINKING=ON
    
    - name: Build
      working-directory: cpp
      run: cmake --build build --parallel $(sysctl -n hw.ncpu)
    
    - name: Test
      working-directory: cpp
      run: |
        cd build
        ./fracessa --help
    
    - name: Upload macOS Binary
      uses: actions/upload-artifact@v4
      with:
        name: fracessa-macos-arm64
        path: cpp/build/fracessa
        retention-days: 30

  # ============================================================================
  # macOS Build (Universal Binary - ARM64 + x86_64)
  # ============================================================================
  build-macos-universal:
    # Build universal binary on macos-latest (Apple Silicon runner)
    # Universal binary works on both Intel and Apple Silicon Macs
    runs-on: macos-latest 
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install pkg-config and GMP
      run: |
        brew install pkg-config gmp
    
    - name: Set up GMP environment variables
      run: |
        # Locate the installation prefix for gmp
        GMP_PREFIX=$(brew --prefix gmp)
        
        # Export the necessary environment variables for CMake to find GMP
        echo "GMP_ROOT=$GMP_PREFIX" >> $GITHUB_ENV
        echo "GMP_INCLUDE_DIR=$GMP_PREFIX/include" >> $GITHUB_ENV
        echo "GMP_LIBRARY_DIR=$GMP_PREFIX/lib" >> $GITHUB_ENV
        echo "GMP_PREFIX=$GMP_PREFIX" >> $GITHUB_ENV
        
        # Set PKG_CONFIG_PATH
        PKG_CONFIG_PATH="$GMP_PREFIX/lib/pkgconfig"
        if [ -d "$PKG_CONFIG_PATH" ]; then
          echo "PKG_CONFIG_PATH=$PKG_CONFIG_PATH" >> $GITHUB_ENV
          echo "Set PKG_CONFIG_PATH=$PKG_CONFIG_PATH"
        fi
        
        # Diagnostics
        echo "GMP installed at: $GMP_PREFIX"
        echo "GMP include dir: $GMP_PREFIX/include"
        echo "GMP library dir: $GMP_PREFIX/lib"
    
    - name: Configure CMake
      working-directory: cpp
      run: |
        # Build universal binary with both ARM64 and x86_64 architectures
        # This creates a single binary that works on both Intel and Apple Silicon Macs
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DENABLE_STATIC_LINKING=ON \
          -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64"  # Universal binary
    
    - name: Build
      working-directory: cpp
      run: cmake --build build --parallel $(sysctl -n hw.ncpu)
    
    - name: Test
      working-directory: cpp
      run: |
        cd build
        # Check architecture to confirm it's a universal binary
        file fracessa
        # Test on native architecture (ARM64 on Apple Silicon runner)
        ./fracessa --help
    
    - name: Upload macOS Universal Binary
      uses: actions/upload-artifact@v4
      with:
        name: fracessa-macos-universal
        path: cpp/build/fracessa
        retention-days: 30

  # ============================================================================
  # Windows Build with MSYS2/MinGW (GMP built from source)
  # ============================================================================
  build-windows:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup MSYS2
      uses: msys2/setup-msys2@v2
      with:
        update: true
        install: >-
          mingw-w64-x86_64-gcc
          mingw-w64-x86_64-make
          mingw-w64-x86_64-autotools
          mingw-w64-x86_64-libtool
          mingw-w64-x86_64-pkg-config
    
    - name: Install GMP from MSYS2 repository
      run: |
        # Use pacman via bash to install GMP in MSYS2 environment
        C:\msys64\usr\bin\bash.exe -lc "pacman -Syu --noconfirm mingw-w64-x86_64-gmp"
        echo "GMP installed from MSYS2 repository"
      shell: cmd
    
    - name: Verify GMP installation (dynamic libraries)
      run: |
        $GMP_ROOT="C:/msys64/mingw64"
        
        echo "Verifying GMP installation (dynamic linking)..."
        # Check for import libraries (.dll.a files)
        if (Test-Path "$GMP_ROOT/lib/libgmp.dll.a") {
          echo "✓ libgmp.dll.a found (import library)"
        } else {
          echo "✗ libgmp.dll.a NOT found"
        }
        if (Test-Path "$GMP_ROOT/lib/libgmpxx.dll.a") {
          echo "✓ libgmpxx.dll.a found (import library)"
        } else {
          echo "✗ libgmpxx.dll.a NOT found"
        }
        # Check for DLL files
        if (Test-Path "$GMP_ROOT/bin/libgmp-10.dll") {
          echo "✓ libgmp-10.dll found"
        } else {
          echo "✗ libgmp-10.dll NOT found"
        }
        if (Test-Path "$GMP_ROOT/bin/libgmpxx-4.dll") {
          echo "✓ libgmpxx-4.dll found"
        } else {
          echo "✗ libgmpxx-4.dll NOT found"
        }
        # Check for headers
        if (Test-Path "$GMP_ROOT/include/gmp.h") {
          echo "✓ gmp.h found"
        } else {
          echo "✗ gmp.h NOT found"
        }
        if (Test-Path "$GMP_ROOT/include/gmpxx.h") {
          echo "✓ gmpxx.h found"
        } else {
          echo "✗ gmpxx.h NOT found"
        }
      shell: powershell
    
    - name: Add MinGW bin directory to PATH
      run: |
        # Add MinGW bin directory to PATH so CMake can find gcc.exe and g++.exe
        # Use the dynamically detected MSYS2 path
        $MSYS2_PATH = $env:MSYS2_MINGW64_PATH
        $BIN_PATH = "$MSYS2_PATH\bin"
        echo $BIN_PATH | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        echo "Added $BIN_PATH to PATH"
      shell: powershell
    
    - name: Detect MSYS2 path and set GMP paths
      shell: msys2 {0}
      run: |
        # Detect actual MSYS2 installation path dynamically
        MSYS2_MINGW64_PATH=$(cygpath -w /mingw64 2>/dev/null || echo "C:/msys64/mingw64")
        # Convert backslashes to forward slashes for consistency
        MSYS2_MINGW64_PATH=$(echo "$MSYS2_MINGW64_PATH" | tr '\\' '/')
        echo "MSYS2_MINGW64_PATH=$MSYS2_MINGW64_PATH" >> $GITHUB_ENV
        echo "Detected MSYS2 path: $MSYS2_MINGW64_PATH"
    
    - name: Set GMP paths for CMake
      run: |
        # Use the dynamically detected MSYS2 path
        $MSYS2_PATH = $env:MSYS2_MINGW64_PATH
        echo "GMP_ROOT=$MSYS2_PATH" >> $env:GITHUB_ENV
        echo "GMP_INCLUDE_DIR=$MSYS2_PATH/include" >> $env:GITHUB_ENV
        echo "GMP_LIBRARY_DIR=$MSYS2_PATH/lib" >> $env:GITHUB_ENV
        echo "GMP installed at: $MSYS2_PATH"
        echo "GMP include dir: $MSYS2_PATH/include"
        echo "GMP library dir: $MSYS2_PATH/lib"
      shell: powershell
    
    - name: Verify GMP installation
      shell: msys2 {0}
      run: |
        echo "Verifying GMP installation in MSYS2..."
        # Convert MSYS2 paths to Windows paths for output
        GMP_H_PATH="/mingw64/include/gmp.h"
        GMPXX_H_PATH="/mingw64/include/gmpxx.h"
        
        if [ -f "$GMP_H_PATH" ]; then
          # Get full Windows path using cygpath
          WIN_PATH=$(cygpath -w "$GMP_H_PATH" 2>/dev/null || echo "C:/msys64$GMP_H_PATH")
          echo "Found: $WIN_PATH"
        else
          WIN_PATH=$(cygpath -w "$GMP_H_PATH" 2>/dev/null || echo "C:/msys64$GMP_H_PATH")
          echo "Error: gmp.h not found at $WIN_PATH"
          echo "Checking /mingw64/include directory:"
          ls -la /mingw64/include/ | head -20
          exit 1
        fi
        if [ -f "$GMPXX_H_PATH" ]; then
          # Get full Windows path using cygpath
          WIN_PATH=$(cygpath -w "$GMPXX_H_PATH" 2>/dev/null || echo "C:/msys64$GMPXX_H_PATH")
          echo "Found: $WIN_PATH"
        else
          WIN_PATH=$(cygpath -w "$GMPXX_H_PATH" 2>/dev/null || echo "C:/msys64$GMPXX_H_PATH")
          echo "Error: gmpxx.h not found at $WIN_PATH"
          exit 1
        fi
        echo "Checking for GMP libraries..."
        echo "Static libraries (.a files):"
        for lib in /mingw64/lib/*gmp*.a; do
          if [ -f "$lib" ] && [[ ! "$lib" =~ \.dll\.a$ ]]; then
            WIN_PATH=$(cygpath -w "$lib" 2>/dev/null || echo "C:/msys64$lib")
            # Convert backslashes to forward slashes to avoid awk escape issues
            WIN_PATH_FORWARD=$(echo "$WIN_PATH" | tr '\\' '/')
            FILE_SIZE=$(ls -lh "$lib" | awk '{print $5}')
            echo "$WIN_PATH_FORWARD ($FILE_SIZE)"
          fi
        done
        echo "Import libraries (.dll.a files):"
        for lib in /mingw64/lib/*gmp*.dll.a; do
          if [ -f "$lib" ]; then
            WIN_PATH=$(cygpath -w "$lib" 2>/dev/null || echo "C:/msys64$lib")
            # Convert backslashes to forward slashes to avoid awk escape issues
            WIN_PATH_FORWARD=$(echo "$WIN_PATH" | tr '\\' '/')
            FILE_SIZE=$(ls -lh "$lib" | awk '{print $5}')
            echo "$WIN_PATH_FORWARD ($FILE_SIZE)"
          fi
        done
        echo "GMP verification complete"
    
    - name: Configure CMake
      working-directory: cpp
      run: |
        # Use the dynamically detected MSYS2 path from environment variable
        $GMP_ROOT = $env:MSYS2_MINGW64_PATH
        if (-not $GMP_ROOT) {
          # Fallback if not set
          $GMP_ROOT = "C:/msys64/mingw64"
        }
        
        echo "Running CMake with explicit GMP paths."
        echo "GMP_ROOT: $GMP_ROOT"
        
        # Verify compilers are in PATH
        where.exe gcc.exe
        where.exe g++.exe
        
        # Verify GMP libraries exist (check for .a files for static linking)
        if (Test-Path "$GMP_ROOT\lib\libgmp.a") {
          echo "Found: $GMP_ROOT\lib\libgmp.a"
        } else {
          echo "Warning: libgmp.a not found, checking for alternatives..."
          Get-ChildItem -Path "$GMP_ROOT\lib" -Filter "*gmp*.a" | Where-Object { $_.Name -notlike "*.dll.a" } | Select-Object Name
        }
        
        if (Test-Path "$GMP_ROOT\lib\libgmpxx.a") {
          echo "Found: $GMP_ROOT\lib\libgmpxx.a"
        } else {
          echo "Warning: libgmpxx.a not found, checking for alternatives..."
          Get-ChildItem -Path "$GMP_ROOT\lib" -Filter "*gmpxx*.a" | Where-Object { $_.Name -notlike "*.dll.a" } | Select-Object Name
        }
        
        # Run the CMake command, correctly substituting the variables and 
        # using explicit arguments to bypass faulty FindGMP logic.
        # Windows uses static linking (.a files)
        # Use $GMP_ROOT variable directly (PowerShell will expand it)
        cmake -B build `
          -DCMAKE_BUILD_TYPE=Release `
          -DENABLE_STATIC_LINKING=ON `
          -G "MinGW Makefiles" `
          -DCMAKE_C_COMPILER="$GMP_ROOT/bin/gcc.exe" `
          -DCMAKE_CXX_COMPILER="$GMP_ROOT/bin/g++.exe" `
          -DGMP_ROOT="$GMP_ROOT" `
          -DGMP_INCLUDE_DIR="$GMP_ROOT/include" `
          -DGMP_LIBRARY_DIR="$GMP_ROOT/lib" `
          -DGMP_LIB="$GMP_ROOT/lib/libgmp.a" `
          -DGMPXX_LIB="$GMP_ROOT/lib/libgmpxx.a" `
          -DGMP_LIBRARIES="$GMP_ROOT/lib/libgmp.a;$GMP_ROOT/lib/libgmpxx.a" `
          -DGMP_FOUND=TRUE
      shell: powershell
    
    - name: Build
      working-directory: cpp
      run: cmake --build build --parallel
    
    - name: Test
      working-directory: cpp
      run: |
        cd build
        if (Test-Path "fracessa.exe") {
          .\fracessa.exe --help
        } else {
          echo "Error: fracessa.exe not found in build directory"
          Get-ChildItem -Path . -Filter "*.exe" | Select-Object Name
          exit 1
        }
      shell: powershell
    
    - name: Upload Windows Binary
      uses: actions/upload-artifact@v4
      with:
        name: fracessa-windows-x86_64
        path: cpp/build/fracessa.exe
        retention-days: 30


  # ============================================================================
  # Upload Release Assets
  # ============================================================================
  upload-release-assets:
    needs: [build-linux, build-macos, build-macos-universal, build-windows]
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    permissions:
      contents: write  # Required to upload release assets
    
    steps:
    - name: Download Linux Binary
      uses: actions/download-artifact@v4
      with:
        name: fracessa-linux-x86_64
        path: ./artifacts/linux
    
    - name: Download macOS ARM Binary
      uses: actions/download-artifact@v4
      with:
        name: fracessa-macos-arm64
        path: ./artifacts/macos
    
    - name: Download macOS Universal Binary
      uses: actions/download-artifact@v4
      with:
        name: fracessa-macos-universal
        path: ./artifacts/macos-universal
    
    - name: Download Windows Binary
      uses: actions/download-artifact@v4
      with:
        name: fracessa-windows-x86_64
        path: ./artifacts/windows
    
    - name: Prepare Release Assets
      run: |
        mkdir -p ./release-assets
        cp ./artifacts/linux/fracessa ./release-assets/fracessa-linux-x86_64
        cp ./artifacts/macos/fracessa ./release-assets/fracessa-macos-arm64
        cp ./artifacts/macos-universal/fracessa ./release-assets/fracessa-macos-universal
        cp ./artifacts/windows/fracessa.exe ./release-assets/fracessa-windows-x86_64.exe
        chmod +x ./release-assets/fracessa-linux-x86_64
        chmod +x ./release-assets/fracessa-macos-arm64
        chmod +x ./release-assets/fracessa-macos-universal
    
    - name: Upload Release Assets
      uses: softprops/action-gh-release@v2
      with:
        files: ./release-assets/*
        draft: false
        prerelease: false
        generate_release_notes: false
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
