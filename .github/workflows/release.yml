name: Build

on:
  release:
    types: [ created, published ]
  workflow_dispatch:

jobs:
  # ============================================================================
  # Linux Build (Ubuntu 20.04 for glibc 2.31 compatibility)
  # ============================================================================
  build-linux:
    runs-on: ubuntu-20.04  # glibc 2.31 - works on most systems from 2020+
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install GMP
      run: |
        sudo apt-get update
        sudo apt-get install -y libgmp-dev libgmpxx4ldbl
    
    - name: Configure CMake
      working-directory: cpp
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DENABLE_STATIC_LINKING=ON
    
    - name: Build
      working-directory: cpp
      run: cmake --build build --parallel $(nproc)
    
    - name: Test
      working-directory: cpp
      run: |
        cd build
        ./fracessa --help
    
    - name: Upload Linux Binary
      uses: actions/upload-artifact@v4
      with:
        name: fracessa-linux-x86_64
        path: cpp/build/fracessa
        retention-days: 30

  # ============================================================================
  # macOS Build
  # ============================================================================
  build-macos:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install pkg-config and GMP
      run: |
        brew install pkg-config gmp
    
    - name: Set up GMP environment variables
      run: |
        # Locate the installation prefix for gmp
        # The prefix is the root directory where the package was installed (e.g., /opt/homebrew)
        GMP_PREFIX=$(brew --prefix gmp)
        
        # Export the necessary environment variables for CMake to find GMP
        # These variables are standard hints for CMake's FindGMP module
        echo "GMP_ROOT=$GMP_PREFIX" >> $GITHUB_ENV
        echo "GMP_INCLUDE_DIR=$GMP_PREFIX/include" >> $GITHUB_ENV
        echo "GMP_LIBRARY_DIR=$GMP_PREFIX/lib" >> $GITHUB_ENV
        echo "GMP_PREFIX=$GMP_PREFIX" >> $GITHUB_ENV
        
        # Set PKG_CONFIG_PATH to help pkg-config find GMP's .pc files
        PKG_CONFIG_PATH="$GMP_PREFIX/lib/pkgconfig"
        if [ -d "$PKG_CONFIG_PATH" ]; then
          echo "PKG_CONFIG_PATH=$PKG_CONFIG_PATH" >> $GITHUB_ENV
          echo "Set PKG_CONFIG_PATH=$PKG_CONFIG_PATH"
        fi
        
        # Verify GMP installation
        echo "GMP installed at: $GMP_PREFIX"
        echo "GMP include dir: $GMP_PREFIX/include"
        echo "GMP library dir: $GMP_PREFIX/lib"
        ls -la $GMP_PREFIX/include/gmp*.h || echo "Warning: GMP headers not found in expected location"
        ls -la $GMP_PREFIX/lib/libgmp* || echo "Warning: GMP libraries not found in expected location"
        
        # Verify pkg-config can find GMP
        if command -v pkg-config &> /dev/null; then
          echo "Checking pkg-config for GMP:"
          pkg-config --modversion gmp || echo "Warning: pkg-config cannot find GMP"
        fi
    
    - name: Configure CMake
      working-directory: cpp
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DENABLE_STATIC_LINKING=ON
    
    - name: Build
      working-directory: cpp
      run: cmake --build build --parallel $(sysctl -n hw.ncpu)
    
    - name: Test
      working-directory: cpp
      run: |
        cd build
        ./fracessa --help
    
    - name: Upload macOS Binary
      uses: actions/upload-artifact@v4
      with:
        name: fracessa-macos-arm64
        path: cpp/build/fracessa
        retention-days: 30

  # ============================================================================
  # Windows Build with vcpkg
  # ============================================================================
  build-windows:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      # Use latest vcpkg instead of pinned commit to get fixes for MSYS2 download issues
    
    - name: Set vcpkg triplet environment variable
      run: |
        echo "VCPKG_TARGET_TRIPLET=x64-windows-static" >> $env:GITHUB_ENV
        echo "Set VCPKG_TARGET_TRIPLET=x64-windows-static"
    
    - name: Install GMP via vcpkg
      run: |
        # Install yasm first (needed for GMP build)
        vcpkg install yasm-tool:x86-windows
        
        # Install GMP
        # Note: This may require downloading MSYS2 tools. If this fails with 404 errors,
        # it's a known issue with vcpkg's MSYS2 mirror URLs. The latest vcpkg should
        # have better handling, but if it still fails, we may need to use an alternative.
        vcpkg install gmp:x64-windows-static --triplet x64-windows-static
    
    - name: Verify GMP installation
      run: |
        echo "VCPKG_ROOT: $env:VCPKG_ROOT"
        echo "VCPKG_TARGET_TRIPLET: $env:VCPKG_TARGET_TRIPLET"
        echo "Checking for GMP headers..."
        if (Test-Path "$env:VCPKG_ROOT\installed\x64-windows-static\include\gmp.h") {
          echo "Found: $env:VCPKG_ROOT\installed\x64-windows-static\include\gmp.h"
        } else {
          echo "Warning: gmp.h not found in installed directory"
        }
        if (Test-Path "$env:VCPKG_ROOT\vcpkg_installed\x64-windows-static\include\gmp.h") {
          echo "Found: $env:VCPKG_ROOT\vcpkg_installed\x64-windows-static\include\gmp.h"
        }
        echo "Checking for GMP libraries..."
        Get-ChildItem -Path "$env:VCPKG_ROOT\installed\x64-windows-static\lib" -Filter "*.lib" | Select-Object -First 5 Name
        if (Test-Path "$env:VCPKG_ROOT\vcpkg_installed\x64-windows-static\lib") {
          Get-ChildItem -Path "$env:VCPKG_ROOT\vcpkg_installed\x64-windows-static\lib" -Filter "*.lib" | Select-Object -First 5 Name
        }
    
    - name: Configure CMake
      working-directory: cpp
      run: |
        cmake -B build `
          -DCMAKE_BUILD_TYPE=Release `
          -DENABLE_STATIC_LINKING=ON `
          -DCMAKE_TOOLCHAIN_FILE="${env:VCPKG_ROOT}/scripts/buildsystems/vcpkg.cmake" `
          -DVCPKG_TARGET_TRIPLET=x64-windows-static
    
    - name: Build
      working-directory: cpp
      run: cmake --build build --config Release --parallel
    
    - name: Test
      working-directory: cpp
      run: |
        cd build/Release
        ./fracessa.exe --help
    
    - name: Upload Windows Binary
      uses: actions/upload-artifact@v4
      with:
        name: fracessa-windows-x86_64
        path: cpp/build/Release/fracessa.exe
        retention-days: 30


  # ============================================================================
  # Upload Release Assets
  # ============================================================================
  upload-release-assets:
    needs: [build-linux, build-macos, build-windows]
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    
    steps:
    - name: Download Linux Binary
      uses: actions/download-artifact@v4
      with:
        name: fracessa-linux-x86_64
        path: ./artifacts/linux
    
    - name: Download macOS Binary
      uses: actions/download-artifact@v4
      with:
        name: fracessa-macos-arm64
        path: ./artifacts/macos
    
    - name: Download Windows Binary
      uses: actions/download-artifact@v4
      with:
        name: fracessa-windows-x86_64
        path: ./artifacts/windows
    
    - name: Prepare Release Assets
      run: |
        mkdir -p ./release-assets
        cp ./artifacts/linux/fracessa ./release-assets/fracessa-linux-x86_64
        cp ./artifacts/macos/fracessa ./release-assets/fracessa-macos-arm64
        cp ./artifacts/windows/fracessa.exe ./release-assets/fracessa-windows-x86_64.exe
        chmod +x ./release-assets/fracessa-linux-x86_64
        chmod +x ./release-assets/fracessa-macos-arm64
    
    - name: Upload Release Assets
      uses: softprops/action-gh-release@v1
      with:
        files: ./release-assets/*
        tag_name: ${{ github.event.release.tag_name }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
